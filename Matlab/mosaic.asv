i1 = imread("../Resources/root_quadrangle01.ppm");
%image1points = cpselect(4)

i2 = imread("../Resources/root_quadrangle02.ppm");
%image2points = cpselect(4)

%i3 = imread("wilson_mural_north03.ppm");
%image3points = cpselect(4)

%i4 = imread("wilson_mural_north04.ppm");
p1 = [5.7 11.5 16.2 15.2 15.2 17.1 17.1 18.5 20.5 19.8 22.6 22.6 24.5 22.9 25.0 25.3 27.7 28.4 28.6 29.3 29.3 31.2 32.5 33.8 38.0 38.8 37.8 39.3 39.0 42.9 42.3 44.5 45.0 47.4 46.7 50.9 51.7 56.4 56.4 56.5 56.3 58.4 58.7 58.7 61.6 61.8 62.0 62.9 63.4 64.0 65.5 66.5 67.2 68.4 69.6 71.1 71.8 71.9 71.2 73.7 74.5 76.3 77.0 78.1 78.1 78.8 80.1 79.7 80.0 81.8 81.1 81.3 83.4 83.0 83.3 83.2 82.9 84.3 85.3 85.3 86.4 86.4 86.4 86.5 86.5 86.5 87.0 87.0 88.5 88.3 87.6 91.1 91.9 91.6 92.3 92.3 93.9 95.0 95.0 95.0 95.5 92.3 96.5 96.9 96.0 97.3 97.3 96.8 96.9 97.8 99.7 98.8 99.6 99.5 100.1 100.3 101.4 101.4 101.2 101.3 101.8 102.2 103.1 103.1 103.9 104.2 104.2 104.3 104.4 104.8 104.9 105.0 105.1 105.2 105.3 105.3 108.1 106.4 106.5 106.7 106.7 107.4 107.3 107.5 108.8 107.6 108.5 109.4 108.6 108.8 110.1 108.6 116.9 110.5 110.5 110.5 110.5 110.2 110.2 110.7 110.7 111.2 113.5 113.4 113.4 113.0 113.7 113.8 114.0 114.5 115.6 116.5 117.3 116.4 116.4 116.4 116.9 116.9 110.5 116.9 117.2 117.2 118.4 118.9 118.9 119.0 120.8 121.1 120.0 120.0 120.0 120.4 120.4 120.6 120.6 120.7 120.6 123.0 124.9 123.1 123.8 123.8 123.6 124.7 123.7 123.7 124.5 123.7 123.7 123.8 124.9 124.6 126.2 126.9 126.9 127.0 127.1 127.7 129.6 129.7 129.6 129.8 129.9 131.0 131.0 133.2 135.0 135.6 136.0 136.0 137.8 138.5 138.9 138.9 139.2 139.2 139.8 139.5 139.5 140.0 140.1 141.7 140.8 141.5 141.8 142.9 144.5 143.4 143.4 144.1 146.1 146.1 146.7 146.7 146.6 146.0 145.8 146.9 147.1 147.1 148.4 147.0 147.5 148.1 147.5 147.8 147.9 147.6 149.6 150.6 151.1 151.3 151.6 152.0 151.6 151.6 152.9 152.7 154.5 153.4 152.9 154.3 154.5 152.9 154.5 154.6 155.3 155.3 154.5 155.0 155.8 155.9 157.7 157.1 157.1 158.5 158.9 159.2 159.3 161.0 161.2 161.2 159.8 162.3 162.5 163.7 164.1 162.7 162.7 163.0 163.1 163.1 166.1 165.3 165.8 167.6 167.6;477.6 236.3 547.0 424.6 364.3 383.0 383.0 214.6 549.9 207.2 210.4 210.4 553.6 197.2 458.1 483.6 192.8 533.7 492.8 364.6 364.6 439.9 454.2 554.8 535.3 194.0 213.8 467.0 201.6 505.8 269.5 559.5 478.5 536.7 380.8 514.5 555.8 530.8 476.9 547.6 371.8 495.4 200.7 200.7 501.0 421.5 276.6 435.2 505.3 418.3 184.3 492.4 508.6 539.8 536.2 532.0 514.7 478.7 201.3 191.9 517.8 520.2 188.7 498.1 498.1 522.9 551.0 478.8 483.6 525.7 224.5 383.0 482.5 195.8 152.2 164.2 411.4 458.8 437.7 437.7 162.2 148.6 148.6 176.3 176.3 176.3 193.1 193.1 550.0 485.3 222.9 463.4 536.2 383.7 460.0 193.1 266.6 200.1 200.1 304.0 310.8 460.0 459.2 476.9 209.4 542.3 542.3 276.9 264.5 376.5 545.2 166.4 463.5 159.9 204.4 267.8 469.8 469.8 195.4 343.0 357.1 337.8 379.8 379.8 383.5 172.4 180.1 183.6 191.1 242.0 219.7 227.2 246.5 251.9 272.5 258.9 554.2 355.2 362.3 379.3 368.5 169.6 176.6 187.8 521.4 381.8 156.3 486.0 270.2 201.5 511.6 255.6 171.0 179.2 179.2 182.8 182.8 319.1 287.1 190.4 190.4 368.6 559.9 227.5 227.5 279.7 175.9 194.3 187.1 426.4 455.0 426.1 495.6 429.1 381.1 381.1 171.0 171.0 179.2 276.5 189.7 189.7 227.6 368.1 368.1 200.6 542.7 559.1 401.5 278.9 278.9 193.9 193.9 175.2 175.2 186.4 354.5 200.6 552.2 387.7 163.6 471.0 170.2 523.6 177.9 177.9 493.1 189.0 189.0 163.6 460.6 197.0 241.6 174.4 185.6 167.0 192.6 413.9 522.2 462.2 175.4 202.3 164.2 299.9 299.9 509.8 141.4 500.0 379.4 379.4 523.4 453.0 155.5 155.5 174.4 174.4 144.4 193.6 193.6 151.4 202.8 524.4 197.5 244.2 263.7 393.7 526.1 399.4 399.4 248.1 472.2 472.2 501.4 501.4 451.4 385.9 218.2 101.2 501.9 141.8 540.0 195.1 171.0 109.4 171.0 190.0 185.2 238.9 472.9 118.4 109.1 470.4 90.7 127.7 190.6 190.6 152.1 418.2 550.0 121.7 188.6 506.5 525.4 152.1 503.1 499.2 510.1 510.1 361.5 382.4 178.1 190.7 527.8 117.8 117.8 510.5 474.3 177.8 186.3 514.0 526.9 526.9 278.2 497.6 170.9 88.3 516.1 209.1 209.1 182.8 189.6 189.6 558.4 505.7 502.0 119.6 119.6]
p2 = [207.9 214.5 217.7 217.9 218.1 219.7 219.7 221.2 221.7 222.7 225.5 225.5 225.5 225.7 227.7 227.9 230.0 230.0 230.5 232.1 232.1 233.5 234.4 235.8 239.9 240.3 240.3 241.9 241.9 245.1 245.2 246.1 247.2 249.2 249.3 252.6 253.3 257.4 258.2 258.3 258.9 260.2 261.1 261.4 263.2 264.0 264.8 265.0 265.1 266.2 267.8 268.2 269.2 269.3 270.5 272.7 273.3 273.6 273.6 276.0 276.1 278.1 279.4 279.5 279.5 280.6 280.6 281.5 281.7 283.1 283.7 284.2 285.0 285.4 285.4 285.4 285.5 285.8 287.4 287.4 288.6 288.8 288.8 288.8 288.8 289.3 289.4 289.4 289.4 289.9 290.2 293.0 293.6 293.9 293.9 294.7 296.6 297.1 297.4 297.7 298.2 298.3 298.3 298.6 298.6 298.7 298.7 299.5 299.7 300.5 300.7 300.9 301.0 301.4 302.6 303.0 303.1 303.1 303.5 303.9 304.3 304.8 305.5 305.5 306.3 306.3 306.5 306.6 306.8 307.5 307.5 307.5 307.7 307.9 308.0 308.0 309.0 309.0 309.0 309.1 309.2 309.5 309.6 309.8 310.1 310.2 310.6 311.1 311.3 311.3 311.4 311.7 312.7 312.8 312.8 312.8 312.8 313.0 313.0 313.1 313.1 313.7 314.4 316.0 316.0 316.0 316.0 316.2 316.3 
316.8 317.4 318.5 318.6 318.7 319.1 319.1 319.2 319.2 319.3 319.4 319.5 319.5 321.1 321.4 321.4 321.4 321.6 321.6 322.3 322.7 322.7 322.8 322.8 322.9 322.9 323.1 323.2 325.4 325.5 325.5 325.6 325.6 325.8 325.9 326.0 326.0 326.0 326.1 326.1 326.2 326.7 327.0 328.9 329.1 329.3 329.3 329.5 329.9 330.6 331.4 332.0 332.1 332.1 333.7 333.7 334.7 337.0 337.1 338.2 338.2 339.0 340.3 341.1 341.1 341.6 341.6 341.9 341.9 341.9 342.2 342.6 342.7 343.4 344.1 344.8 345.4 345.8 345.9 345.9 346.9 348.0 348.0 348.2 348.2 348.4 348.5 348.6 348.6 349.0 349.2 349.4 349.6 349.9 349.9 350.1 350.3 350.3 350.5 351.5 352.5 352.9 353.1 353.1 354.0 354.1 354.1 355.1 355.1 355.3 355.4 355.5 355.7 355.7 356.0 356.1 356.2 356.7 356.7 357.2 357.7 358.3 358.5 358.9 359.0 359.0 360.0 360.7 361.6 361.8 362.3 362.4 362.4 362.7 363.8 365.0 365.3 365.5 365.5 365.5 365.5 365.6 365.6 366.6 366.8 
367.3 369.7 369.7;
474.5 235.0 543.0 421.9 362.1 380.7 380.7 213.4 545.8 206.0 209.1 209.1 549.6 196.1 455.2 480.4 190.7 530.2 489.9 362.4 362.4 437.4 451.5 551.8 532.2 192.4 212.5 464.3 200.2 502.9 267.8 556.8 475.9 534.0 378.6 511.5 553.2 528.2 474.4 545.0 369.7 492.8 199.1 199.8 498.4 419.4 274.9 433.0 502.7 416.2 183.1 490.1 505.9 537.4 533.8 529.6 512.0 476.5 199.7 190.2 515.3 517.6 187.1 496.0 496.0 520.5 548.6 476.8 481.6 523.2 222.8 381.2 480.6 194.0 150.5 162.7 409.6 456.9 435.7 435.7 160.5 146.6 146.6 174.5 174.5 186.4 191.3 191.3 547.8 483.5 221.2 461.6 534.3 381.9 458.0 191.4 264.8 198.5 198.3 302.1 309.2 457.2 457.2 475.1 207.6 540.2 540.2 275.1 262.7 374.8 543.2 164.5 461.7 158.0 202.6 265.9 468.1 468.1 193.7 341.1 355.0 336.1 378.0 378.0 381.8 170.5 178.2 181.7 189.1 240.1 217.8 225.4 244.6 250.0 270.8 257.0 552.4 353.3 360.6 377.5 367.1 167.6 174.7 185.9 519.8 
380.1 154.3 484.5 268.4 199.5 510.0 253.8 169.7 177.2 177.2 180.8 180.8 317.3 285.2 188.4 188.4 366.9 558.3 225.5 225.5 277.9 173.9 192.3 185.0 424.8 453.2 424.6 494.2 427.6 379.5 379.5 168.9 168.9 176.7 274.5 187.7 187.7 225.6 366.3 366.3 198.6 541.4 558.0 399.9 277.1 277.1 191.8 191.8 173.1 173.1 184.3 352.8 198.5 551.1 386.2 161.4 469.6 168.1 522.4 175.7 175.7 491.8 186.8 186.8 161.4 459.2 194.9 239.7 172.2 183.5 164.7 190.4 412.4 521.3 460.9 173.1 200.2 161.8 298.0 298.0 508.8 139.0 498.9 377.9 377.9 522.4 451.6 153.2 153.2 172.1 172.1 141.9 191.4 191.4 148.9 200.5 523.6 195.2 242.2 261.8 392.3 525.4 398.0 398.0 246.0 471.2 471.2 500.5 500.5 450.1 384.4 216.1 98.4 500.9 138.9 539.3 192.8 168.4 106.6 178.6 187.2 
182.8 236.8 472.0 115.6 106.0 469.4 87.8 124.8 188.2 188.2 149.4 417.0 549.5 118.9 186.1 505.9 524.8 150.0 502.4 498.4 509.4 509.4 360.0 381.1 175.4 188.2 527.3 114.8 114.8 509.9 473.4 175.2 183.8 513.5 526.5 526.5 276.1 497.2 168.2 85.1 515.7 206.6 206.6 180.2 187.1 187.1 558.1 505.2 501.4 116.5 116.5]
%image4points = cpselect(4)
%defaultp1 = [511.0490 297.7059; 411.8750 316.1250; 485.3750 240.8750; 492.3750 75.3750; 501.3750  140.6250; 434.8750  160.1250];
%defaultp2 = [214.3750 292.8750; 98.6250 310.3750; 190.6250 229.8750; 219.6250 60.3750; 221.8750 124.8750; 144.8750 147.3750];

%defaultp3 = [288.3750  163.3750; 291.8750  234.8750; 354.6250  191.1250; 422.1250  345.6250; 446.6250  298.1250; 495.8750  294.3750]
%defaultp4 = [69.3750  109.3750; 52.3750  153.3750; 116.3750  120.1250; 137.1250  218.8750; 176.8750  184.1250; 230.3750  177.8750]
%[p1 p2] = cpselect(i1, i2, defaultp1, defaultp2,'Wait', true);
% This command requires matlab 2007 or newer
%[p3 p4] = cpselect(i3, i4, p3, p4, 'Wait', true)
% cpselect(i1, i2, input_points, base_points);
% should work on older versions, but will not wait to execute the
% rest of the script

% Make a resampler for transforming images
R = makeresampler({'linear','linear'},'bound');
% Create a Tform that maps input to base
T1 = cp2tform(p1,p2,'projective');
% Create an identity Tform
T2 = maketform('projective',eye(3));

% Transform both images and record the max and min, x and y coordinates
[i3t, x1, y1] = imtransform(i1, T1);
[i4t, x2, y2] = imtransform(i2, T2);

% Combine the x and y coordinates
x = [ x1; x2];
y = [ y1; y2];
% Find the max of the maxs and the min of the mins
xdata = [min(x(:,1)) max(x(:,2))];
ydata = [min(y(:,1)) max(y(:,2))];

% Transform both images specifying the x and y ranges
i1t = imtransform(i1, T1, R, 'XData', xdata, 'YData', ydata);
i2t = imtransform(i2, T2, R, 'XData', xdata, 'YData', ydata);

% Combine the 2 images
comb1 = imlincomb(0.5, i1t, 0.5, i2t);
comb1 = 0.5*i1t+0.5*i2t;
figure(5)
imshow(comb1);

% combineImages can be used to get rid of the changes in brightness


% Make a resampler for transforming images
R = makeresampler({'linear','linear'},'bound');
% Create a Tform that maps input to base
T3 = cp2tform(p3,p4,'projective');
% Create an identity Tform
T4 = maketform('projective',eye(3));

% Transform both images and record the max and min, x and y coordinates
[i3t, x3, y3] = imtransform(i3, T3);
[i4t, x4, y4] = imtransform(i4, T4);

% Combine the x and y coordinates
x = [ x3; x4];
y = [ y3; y4];
% Find the max of the maxs and the min of the mins
xdata = [min(x(:,1)) max(x(:,2))];
ydata = [min(y(:,1)) max(y(:,2))];

% Transform both images specifying the x and y ranges
i3t = imtransform(i3, T3, R, 'XData', xdata, 'YData', ydata);
i4t = imtransform(i4, T4, R, 'XData', xdata, 'YData', ydata);

% Combine the 2 images
comb2 = imlincomb(0.5, i3t, 0.5, i4t);
comb2 = 0.5*i3t+0.5*i4t;
figure(6)
imshow(comb2);



%defaultp5 = [710.3750  247.3750; 804.3750  328.8750; 655.6250  368.6250; 699.6250   69.1250; 605.6250  140.6250; 758.3750  185.3750]
%defaultp6 = [97.3750  223.3750; 131.1250  264.1250; 27.3750  288.3750; 150.8750  125.1250; 74.3750  165.3750; 148.3750  188.3750]
%[p5 p6] = cpselect(comb1, comb2, p5, p6, 'Wait', true)
%T1 = cp2tform(defaultp1,defaultp2,'projective');
% Create an identity Tform
R = makeresampler({'linear','linear'},'bound');
% Create a Tform that maps input to base
T6 = cp2tform(p6,p5,'projective');
% Create an identity Tform
T5 = maketform('projective',eye(3));

% Transform both images and record the max and min, x and y coordinates
[i5t, x5, y5] = imtransform(i3, T5);
[i6t, x6, y6] = imtransform(i4, T6);

% Combine the x and y coordinates
x = [ x5; x6];
y = [ y5; y6];
% Find the max of the maxs and the min of the mins
xdata = [min(x(:,1)) max(x(:,2))];
ydata = [min(y(:,1)) max(y(:,2))];

% Transform both images specifying the x and y ranges
i5t = imtransform(comb1, T5, R, 'XData', xdata, 'YData', ydata);
i6t = imtransform(comb2, T6, R, 'XData', xdata, 'YData', ydata);

% Combine the 2 images
comb3 = imlincomb(0.5, i5t, 0.5, i6t);
comb3 = 0.5*i5t+0.5*i6t;
figure(7)
imshow(comb3);
%imsave
